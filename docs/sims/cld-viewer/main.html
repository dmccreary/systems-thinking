<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causal Loop Diagram Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 300;
        }
        
        .diagram-title {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            font-size: 1.5em;
            font-weight: 500;
            color: #495057;
        }
        
        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .file-input-wrapper:hover {
            background: #0056b3;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .sample-buttons {
            display: inline-block;
        }
        
        .sample-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .sample-btn:hover {
            background: #1e7e34;
        }
        
        #network {
            width: 100%;
            height: 600px;
            border: 1px solid #e9ecef;
        }
        
        .details-panel {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            min-height: 150px;
        }
        
        .details-panel h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .details-content {
            line-height: 1.6;
        }
        
        .details-content p {
            margin: 10px 0;
        }
        
        .details-content .label {
            font-weight: bold;
            color: #495057;
        }
        
        .loop-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .loop-info.reinforcing {
            border-left-color: #dc3545;
        }
        
        .loop-info.balancing {
            border-left-color: #28a745;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Causal Loop Diagram Viewer</h1>
        </div>
        
        <div class="diagram-title" id="diagram-title">
            Load a CLD file to begin
        </div>
        
        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="file-input" accept=".json" />
                Load CLD File
            </div>
            <div class="sample-buttons">
                <button class="sample-btn" onclick="loadSample('banning-books')">Book Banning Example</button>
                <button class="sample-btn" onclick="loadSample('ai-training')">AI Training Example</button>
            </div>
        </div>
        
        <div id="network"></div>
        
        <div class="details-panel">
            <h3>Details</h3>
            <div class="details-content" id="details-content">
                Click on a node, edge, or loop symbol to see details here.
            </div>
        </div>
    </div>

    <script>
        let network = null;
        let cldData = null;
        let nodes, edges;

        // Sample data for demonstration
        const sampleData = {
            'banning-books': {
                "metadata": {
                    "title": "Banning Books to Protect Students",
                    "archetype": "fixes-that-fail"
                },
                "nodes": [
                    {
                        "id": "community_concerns",
                        "label": "Community Concerns About Content",
                        "position": {"x": 100, "y": 100},
                        "description": "Parent groups and community members express concerns about books containing mature themes, controversial topics, or content deemed inappropriate"
                    },
                    {
                        "id": "book_banning_policies",
                        "label": "Book Banning Policies",
                        "position": {"x": 400, "y": 100},
                        "description": "Sweeping book removal policies, restrictive approval processes, and preemptive censorship measures"
                    },
                    {
                        "id": "immediate_relief",
                        "label": "Immediate Relief",
                        "position": {"x": 700, "y": 100},
                        "description": "Short-term reduction in complaints and community tension as visible action is taken"
                    },
                    {
                        "id": "educational_degradation",
                        "label": "Educational Degradation",
                        "position": {"x": 700, "y": 400},
                        "description": "Diminished learning engagement, critical thinking opportunities, and intellectual development"
                    },
                    {
                        "id": "worse_outcomes",
                        "label": "Worse Educational Outcomes",
                        "position": {"x": 400, "y": 400},
                        "description": "Declining academic performance, reduced college readiness, and broader educational dysfunction"
                    },
                    {
                        "id": "pressure_for_restrictions",
                        "label": "Pressure for More Restrictions",
                        "position": {"x": 100, "y": 400},
                        "description": "Increased pressure to implement even more restrictive censorship policies and expand banned book lists"
                    }
                ],
                "edges": [
                    {
                        "id": "concerns_to_policies",
                        "source": "community_concerns",
                        "target": "book_banning_policies",
                        "polarity": "positive",
                        "description": "Community concerns directly lead to implementation of book banning policies"
                    },
                    {
                        "id": "policies_to_relief",
                        "source": "book_banning_policies",
                        "target": "immediate_relief",
                        "polarity": "positive",
                        "description": "Book banning policies provide immediate visible action that reduces complaints"
                    },
                    {
                        "id": "policies_to_degradation",
                        "source": "book_banning_policies",
                        "target": "educational_degradation",
                        "polarity": "positive",
                        "description": "Restrictive policies diminish educational quality and student engagement"
                    },
                    {
                        "id": "degradation_to_outcomes",
                        "source": "educational_degradation",
                        "target": "worse_outcomes",
                        "polarity": "positive",
                        "description": "Educational degradation leads to measurably worse academic and social outcomes"
                    },
                    {
                        "id": "outcomes_to_pressure",
                        "source": "worse_outcomes",
                        "target": "pressure_for_restrictions",
                        "polarity": "positive",
                        "description": "Poor outcomes create pressure to implement even more restrictive policies"
                    },
                    {
                        "id": "pressure_to_policies",
                        "source": "pressure_for_restrictions",
                        "target": "book_banning_policies",
                        "polarity": "positive",
                        "description": "Pressure for more restrictions leads to expanded and more severe banning policies"
                    }
                ],
                "loops": [
                    {
                        "id": "quick_fix_loop",
                        "type": "balancing",
                        "path": ["community_concerns", "book_banning_policies", "immediate_relief"],
                        "label": "Quick Fix Loop",
                        "description": "The initial balancing loop where book banning policies temporarily reduce community concerns",
                        "position": {"x": 400, "y": 60}
                    },
                    {
                        "id": "unintended_consequences_loop",
                        "type": "reinforcing",
                        "path": ["book_banning_policies", "educational_degradation", "worse_outcomes", "pressure_for_restrictions"],
                        "label": "Unintended Consequences Loop",
                        "description": "The reinforcing loop where banning policies create educational problems that generate pressure for even more restrictions",
                        "position": {"x": 500, "y": 300}
                    }
                ]
            },
            'ai-training': {
                "metadata": {
                    "title": "Cutting AI Training Budgets to Preserve Traditional Education Funding",
                    "archetype": "fixes-that-fail"
                },
                "nodes": [
                    {
                        "id": "budget_pressure",
                        "label": "Budget Pressure",
                        "position": {"x": 100, "y": 200},
                        "description": "Financial constraints forcing difficult choices about professional development spending"
                    },
                    {
                        "id": "ai_training_cuts",
                        "label": "AI Training Budget Cuts",
                        "position": {"x": 300, "y": 100},
                        "description": "Decision to eliminate or reduce AI literacy training for teachers"
                    },
                    {
                        "id": "traditional_program_funding",
                        "label": "Traditional Program Funding",
                        "position": {"x": 500, "y": 200},
                        "description": "Maintained or increased funding for established professional development programs"
                    },
                    {
                        "id": "teacher_ai_competency",
                        "label": "Teacher AI Competency",
                        "position": {"x": 300, "y": 300},
                        "description": "Teachers' ability to effectively use and integrate AI tools in education"
                    },
                    {
                        "id": "teacher_confidence",
                        "label": "Teacher Professional Confidence",
                        "position": {"x": 500, "y": 400},
                        "description": "Teachers' confidence in their ability to handle modern educational challenges"
                    },
                    {
                        "id": "teacher_retention",
                        "label": "Teacher Retention Rate",
                        "position": {"x": 700, "y": 300},
                        "description": "Percentage of teachers remaining in the district year-over-year"
                    },
                    {
                        "id": "staffing_costs",
                        "label": "Total Staffing Costs",
                        "position": {"x": 900, "y": 400},
                        "description": "Total cost of recruiting, hiring, and retaining teaching staff"
                    }
                ],
                "edges": [
                    {
                        "id": "budget_to_cuts",
                        "source": "budget_pressure",
                        "target": "ai_training_cuts",
                        "polarity": "positive",
                        "description": "Higher budget pressure leads to more AI training cuts"
                    },
                    {
                        "id": "cuts_to_competency",
                        "source": "ai_training_cuts",
                        "target": "teacher_ai_competency",
                        "polarity": "negative",
                        "description": "Cutting AI training reduces teacher AI competency"
                    },
                    {
                        "id": "competency_to_confidence",
                        "source": "teacher_ai_competency",
                        "target": "teacher_confidence",
                        "polarity": "positive",
                        "description": "Higher AI competency increases teacher confidence in modern challenges"
                    },
                    {
                        "id": "confidence_to_retention",
                        "source": "teacher_confidence",
                        "target": "teacher_retention",
                        "polarity": "positive",
                        "description": "More confident teachers are more likely to stay in the profession"
                    },
                    {
                        "id": "retention_to_costs",
                        "source": "teacher_retention",
                        "target": "staffing_costs",
                        "polarity": "negative",
                        "description": "Higher retention reduces turnover and recruitment costs"
                    },
                    {
                        "id": "costs_to_pressure",
                        "source": "staffing_costs",
                        "target": "budget_pressure",
                        "polarity": "positive",
                        "description": "Higher staffing costs increase overall budget pressure"
                    }
                ],
                "loops": [
                    {
                        "id": "fixes_that_fail_loop",
                        "type": "reinforcing",
                        "path": ["budget_pressure", "ai_training_cuts", "teacher_ai_competency", "teacher_confidence", "teacher_retention", "staffing_costs", "budget_pressure"],
                        "label": "Fixes That Fail Loop",
                        "description": "Cutting AI training to save money ultimately increases costs through teacher turnover",
                        "position": {"x": 400, "y": 350}
                    }
                ]
            }
        };

        function initializeNetwork() {
            const container = document.getElementById('network');
            const options = {
                layout: {
                    improvedLayout: false
                },
                physics: {
                    enabled: false
                },
                interaction: {
                    selectConnectedEdges: false
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    font: {
                        size: 14,
                        face: 'Arial'
                    },
                    borderWidth: 2,
                    shadow: true,
                    color: {
                        background: '#E8F4FD',
                        border: '#4A90E2',
                        highlight: {
                            background: '#D1E7DD',
                            border: '#198754'
                        }
                    }
                },
                edges: {
                    arrows: {
                        to: { enabled: true, scaleFactor: 1.2 }
                    },
                    color: {
                        color: '#848484',
                        highlight: '#198754'
                    },
                    width: 2,
                    smooth: {
                        type: 'curvedCW',
                        roundness: 0.2
                    },
                    font: {
                        size: 12,
                        strokeWidth: 3,
                        strokeColor: 'white'
                    }
                }
            };

            network = new vis.Network(container, {}, options);

            // Event listeners for node and edge selection
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    showNodeDetails(params.nodes[0]);
                } else if (params.edges.length > 0) {
                    showEdgeDetails(params.edges[0]);
                } else {
                    showDefaultDetails();
                }
            });
        }

        function loadCLD(data) {
            try {
                cldData = data;
                
                // Update title
                document.getElementById('diagram-title').textContent = data.metadata.title;

                // Convert nodes for vis.js
                const visNodes = data.nodes.map(node => ({
                    id: node.id,
                    label: wrapText(node.label, 20),
                    x: node.position.x,
                    y: node.position.y,
                    title: node.description || '',
                    originalData: node
                }));

                // Convert edges for vis.js
                const visEdges = data.edges.map(edge => ({
                    id: edge.id,
                    from: edge.source,
                    to: edge.target,
                    label: edge.polarity === 'positive' ? '+' : '-',
                    color: edge.polarity === 'positive' ? '#28a745' : '#dc3545',
                    originalData: edge
                }));

                // Add loop symbols as nodes
                if (data.loops) {
                    data.loops.forEach(loop => {
                        if (loop.position) {
                            visNodes.push({
                                id: 'loop_' + loop.id,
                                label: loop.type === 'reinforcing' ? 'R' : 'B',
                                x: loop.position.x,
                                y: loop.position.y,
                                shape: 'circle',
                                size: 30,
                                color: {
                                    background: loop.type === 'reinforcing' ? '#dc3545' : '#28a745',
                                    border: '#000000'
                                },
                                font: {
                                    color: 'white',
                                    size: 16,
                                    face: 'Arial bold'
                                },
                                title: loop.description || '',
                                originalData: loop,
                                isLoop: true
                            });
                        }
                    });
                }

                nodes = new vis.DataSet(visNodes);
                edges = new vis.DataSet(visEdges);

                network.setData({ nodes: nodes, edges: edges });
                
                showDefaultDetails();
                
            } catch (error) {
                showError('Error loading CLD data: ' + error.message);
            }
        }

        function wrapText(text, maxLength) {
            if (text.length <= maxLength) return text;
            
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            for (const word of words) {
                if ((currentLine + ' ' + word).length <= maxLength) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) lines.push(currentLine);
            
            return lines.join('\n');
        }

        function showNodeDetails(nodeId) {
            const nodeData = nodes.get(nodeId);
            if (!nodeData) return;

            let content = '';
            
            if (nodeData.isLoop) {
                const loop = nodeData.originalData;
                content = `
                    <div class="loop-info ${loop.type}">
                        <h4>${loop.label || loop.id}</h4>
                        <p><span class="label">Type:</span> ${loop.type === 'reinforcing' ? 'Reinforcing (R)' : 'Balancing (B)'}</p>
                        <p><span class="label">Description:</span> ${loop.description || 'No description available'}</p>
                        ${loop.behavior_pattern ? `<p><span class="label">Behavior Pattern:</span> ${loop.behavior_pattern}</p>` : ''}
                        ${loop.path ? `<p><span class="label">Path:</span> ${loop.path.join(' â†’ ')}</p>` : ''}
                    </div>
                `;
            } else {
                const node = nodeData.originalData;
                content = `
                    <h4>${node.label}</h4>
                    <p><span class="label">Type:</span> ${node.type || 'variable'}</p>
                    <p><span class="label">Description:</span> ${node.description || 'No description available'}</p>
                    ${node.examples ? `<p><span class="label">Examples:</span> ${node.examples.join(', ')}</p>` : ''}
                    ${node.measurement ? `<p><span class="label">Measurement:</span> ${node.measurement}</p>` : ''}
                `;
            }

            document.getElementById('details-content').innerHTML = content;
        }

        function showEdgeDetails(edgeId) {
            const edgeData = edges.get(edgeId);
            if (!edgeData) return;

            const edge = edgeData.originalData;
            const sourceNode = cldData.nodes.find(n => n.id === edge.source);
            const targetNode = cldData.nodes.find(n => n.id === edge.target);

            const content = `
                <h4>Causal Relationship</h4>
                <p><span class="label">From:</span> ${sourceNode ? sourceNode.label : edge.source}</p>
                <p><span class="label">To:</span> ${targetNode ? targetNode.label : edge.target}</p>
                <p><span class="label">Polarity:</span> ${edge.polarity === 'positive' ? 'Positive (+)' : 'Negative (-)'}</p>
                <p><span class="label">Description:</span> ${edge.description || 'No description available'}</p>
                ${edge.strength ? `<p><span class="label">Strength:</span> ${edge.strength}</p>` : ''}
                ${edge.delay && edge.delay.present ? `<p><span class="label">Delay:</span> ${edge.delay.duration || 'Present'}</p>` : ''}
            `;

            document.getElementById('details-content').innerHTML = content;
        }

        function showDefaultDetails() {
            let content = '<p>Click on a node, edge, or loop symbol to see details here.</p>';
            
            if (cldData) {
                content += `
                    <h4>System Overview</h4>
                    <p><span class="label">Archetype:</span> ${cldData.metadata.archetype || 'Not specified'}</p>
                    <p><span class="label">Description:</span> ${cldData.metadata.description || 'No description available'}</p>
                `;
                
                if (cldData.loops && cldData.loops.length > 0) {
                    content += '<h4>Feedback Loops</h4>';
                    cldData.loops.forEach(loop => {
                        content += `
                            <div class="loop-info ${loop.type}">
                                <strong>${loop.label || loop.id}</strong> (${loop.type === 'reinforcing' ? 'R' : 'B'})
                                <br>${loop.description || 'No description'}
                            </div>
                        `;
                    });
                }
            }

            document.getElementById('details-content').innerHTML = content;
        }

        function showError(message) {
            document.getElementById('details-content').innerHTML = `<div class="error">${message}</div>`;
        }

        function loadSample(sampleName) {
            if (sampleData[sampleName]) {
                loadCLD(sampleData[sampleName]);
            }
        }

        // File input handler
        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadCLD(data);
                    } catch (error) {
                        showError('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Initialize the network when the page loads
        window.addEventListener('load', function() {
            initializeNetwork();
            showDefaultDetails();
        });
    </script>
</body>
</html>